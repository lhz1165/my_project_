调度  sdk -> controller ->apply



apply:

1. 查询订单，订单状态为进行中，返回结果保证幂等

2. 准备申请主机
   1. 查询基本参数(机房，启动方案，配置id，默认参数，查询算力规格,空闲客户机(所有的-使用的))
   2. 使用上面的参数，通过rpc去资源池申请资源
      1. 选择一台空闲客户机
      2. 结束机房主机申请记录并保存资产包调度订单与明细
         1. 更新为结束
         2. 保存【资产包调度订单(回调签名，状态进行中)】，保存【资产包调度订单明细(机器信息)】
3. 正真的开机：下发方案配置，下发vlan主机开机







2.2.1选择空闲客户机，可能多个并发请求，在【资产包使用客户机记录入库】表中，用客户机ip，网吧id，资产包id作为联合唯一，只要插入失败就表示客户机申请失败，抛出异常返回



通过kafka监听开机情况

如果是开机成功，更新订单计费时间，通过线程池异步回调（衰减 0 -> 3 -> 9 -> 27 -> 81）

第一次，插入【回调通知表】，以后更新表的次数，使用post请求，为了安全对请求进行加密，对方收到通知返回success更订【回调通知表】后不通知。







如果线程池异步回调通，知时突然出现问题了。重启后SDK通知补偿，针对最近一次通知时间超过30分钟并且通知次数小于10次的未响应通知

